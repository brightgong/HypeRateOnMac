# HypeRateOnMac

HypeRateOnMac æ˜¯ä¸€æ¬¾ macOS èœå•æ åº”ç”¨ç¨‹åºï¼Œç”¨äºå®æ—¶æ˜¾ç¤º HypeRate è®¾å¤‡çš„å¿ƒç‡æ•°æ®ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **å®æ—¶å¿ƒç‡æ˜¾ç¤º**ï¼šé€šè¿‡ WebSocket è¿æ¥å®æ—¶è·å–å¹¶æ˜¾ç¤ºå¿ƒç‡æ•°æ®
- **èœå•æ é›†æˆ**ï¼šåœ¨ macOS èœå•æ ä¸­æ˜¾ç¤ºå½“å‰å¿ƒç‡ï¼ˆBPMï¼‰
- **è¿æ¥çŠ¶æ€å¯è§†åŒ–**ï¼š
  - â¤ï¸ å·²è¿æ¥ï¼šæ˜¾ç¤ºçº¢è‰²çˆ±å¿ƒå›¾æ ‡å’Œå¿ƒç‡æ•°å€¼
  - ğŸ’” å·²æ–­å¼€ï¼šæ˜¾ç¤ºç°è‰²è£‚å¿ƒå›¾æ ‡
  - è¿æ¥ä¸­ï¼šæ˜¾ç¤ºæ©™è‰²çˆ±å¿ƒå›¾æ ‡
- **è‡ªåŠ¨é‡è¿**ï¼šè¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿ï¼Œé‡‡ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
- **å¿ƒè·³ä¿æ´»**ï¼šæ¯ 10 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³æ¶ˆæ¯ä¿æŒè¿æ¥
- **é…ç½®æŒä¹…åŒ–**ï¼šä½¿ç”¨ UserDefaults ä¿å­˜è®¾å¤‡ ID
- **è°ƒè¯•æ—¥å¿—**ï¼šè¯¦ç»†çš„å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

## é¡¹ç›®ç»“æ„

```
HypeRateOnMac/
â”œâ”€â”€ HypeRateOnMac/
â”‚   â”œâ”€â”€ HypeRateOnMacApp.swift          # åº”ç”¨å…¥å£å’Œ AppDelegate
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â””â”€â”€ HeartRateData.swift         # å¿ƒç‡æ•°æ®æ¨¡å‹å’Œè¿æ¥çŠ¶æ€æšä¸¾
â”‚   â”œâ”€â”€ ViewModels/
â”‚   â”‚   â””â”€â”€ HeartRateViewModel.swift    # è§†å›¾æ¨¡å‹ï¼Œåè°ƒ UI å’Œä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ Views/
â”‚   â”‚   â”œâ”€â”€ MenuBarView.swift           # èœå•æ å¼¹å‡ºè§†å›¾
â”‚   â”‚   â””â”€â”€ SettingsView.swift          # è®¾ç½®ç•Œé¢
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ HeartRateService.swift      # WebSocket æœåŠ¡å’Œå¿ƒç‡æ•°æ®å¤„ç†
â”‚   â”‚   â””â”€â”€ SettingsService.swift       # è®¾ç½®æŒä¹…åŒ–æœåŠ¡
â”‚   â”œâ”€â”€ Assets.xcassets/                # èµ„æºæ–‡ä»¶
â”‚   â””â”€â”€ HypeRateOnMac.entitlements      # åº”ç”¨æƒé™é…ç½®
â””â”€â”€ HypeRateOnMac.xcodeproj/            # Xcode é¡¹ç›®æ–‡ä»¶
```

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**ï¼šSwift 5.0+
- **æ¡†æ¶**ï¼š
  - SwiftUIï¼šç”¨æˆ·ç•Œé¢
  - Combineï¼šå“åº”å¼æ•°æ®æµ
  - AppKitï¼šmacOS ç³»ç»Ÿé›†æˆï¼ˆNSStatusItemã€NSPopoverï¼‰
  - Foundationï¼šç½‘ç»œå’ŒåŸºç¡€æœåŠ¡
- **ç½‘ç»œ**ï¼šURLSessionWebSocketTaskï¼ˆWebSocket è¿æ¥ï¼‰
- **å®šæ—¶å™¨**ï¼šDispatchSourceTimerï¼ˆå¯é çš„å¿ƒè·³å’Œé‡è¿ï¼‰

## ä½¿ç”¨è¯´æ˜

### 1. é…ç½®åº”ç”¨

é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œéœ€è¦é…ç½®ä½ çš„ HypeRate è®¾å¤‡ IDï¼š

- **è®¾å¤‡ ID**ï¼šä½ çš„ HypeRate è®¾å¤‡ IDï¼ˆ3-6 ä½å­—æ¯æ•°å­—ç»„åˆï¼Œå¿…éœ€ï¼‰

### 2. è¿æ¥è®¾å¤‡

é…ç½®å®Œæˆåï¼Œåº”ç”¨ä¼šè‡ªåŠ¨è¿æ¥åˆ° HypeRate WebSocket æœåŠ¡ã€‚

- WebSocket ç«¯ç‚¹ï¼š`wss://app.hyperate.io/ws/{device_id}?token={api_key}`
- è¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨åŠ å…¥é¢‘é“å¹¶å¼€å§‹æ¥æ”¶å¿ƒç‡æ•°æ®
- æ¯ 10 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ä¿æ´»

### 3. æŸ¥çœ‹å¿ƒç‡

- ç‚¹å‡»èœå•æ å›¾æ ‡æŸ¥çœ‹è¯¦ç»†å¿ƒç‡ä¿¡æ¯
- èœå•æ æ˜¾ç¤ºæ ¼å¼ï¼š`â¤ï¸ 78`ï¼ˆå·²è¿æ¥ï¼‰æˆ– `ğŸ’” --`ï¼ˆå·²æ–­å¼€ï¼‰
- å¼¹å‡ºçª—å£æ˜¾ç¤ºå½“å‰å¿ƒç‡ã€è¿æ¥çŠ¶æ€å’Œè®¾å¤‡ ID

### 4. ä¿®æ”¹è®¾ç½®

- ç‚¹å‡»è®¾å¤‡ ID åŒºåŸŸå±•å¼€ç¼–è¾‘ç•Œé¢
- ä¿®æ”¹è®¾å¤‡ ID åä¼šè‡ªåŠ¨é‡æ–°è¿æ¥

## WebSocket åè®®

åº”ç”¨ä½¿ç”¨ HypeRate WebSocket APIï¼Œéµå¾ª Phoenix æ¡†æ¶çš„é¢‘é“åè®®ï¼š

### æ¶ˆæ¯æ ¼å¼

```json
{
  "topic": "hr:{device_id}",
  "event": "phx_join|phx_leave|ping|hr_update",
  "payload": {},
  "ref": "1"
}
```

### ä¸»è¦æ¶ˆæ¯ç±»å‹

- **phx_join**ï¼šåŠ å…¥å¿ƒç‡é¢‘é“
- **phx_leave**ï¼šç¦»å¼€å¿ƒç‡é¢‘é“
- **ping**ï¼šå¿ƒè·³ä¿æ´»æ¶ˆæ¯
- **hr_update**ï¼šå¿ƒç‡æ›´æ–°äº‹ä»¶
- **phx_reply**ï¼šæœåŠ¡å™¨ç¡®è®¤æ¶ˆæ¯

### å¿ƒç‡æ›´æ–°å“åº”

```json
{
  "event": "hr_update",
  "payload": {
    "hr": 78
  }
}
```

## è¿æ¥çŠ¶æ€

åº”ç”¨ä½¿ç”¨ `ConnectionState` æšä¸¾ç®¡ç†è¿æ¥çŠ¶æ€ï¼š

- `disconnected`ï¼šæœªè¿æ¥ï¼ˆç°è‰² #8E8E93ï¼‰
- `connecting`ï¼šè¿æ¥ä¸­ï¼ˆæ©™è‰² #FF9500ï¼‰
- `connected`ï¼šå·²è¿æ¥ï¼ˆç»¿è‰² #34C759ï¼‰
- `error(String)`ï¼šé”™è¯¯çŠ¶æ€ï¼ˆçº¢è‰² #FF3B30ï¼‰

## é‡è¿æœºåˆ¶

å½“è¿æ¥æ–­å¼€æ—¶ï¼Œåº”ç”¨ä¼šè‡ªåŠ¨å°è¯•é‡è¿ï¼š

- æœ€å¤§é‡è¿æ¬¡æ•°ï¼š10 æ¬¡
- é‡è¿å»¶è¿Ÿï¼šé‡‡ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ2s, 4s, 8s... æœ€å¤§ 60sï¼‰
- é‡è¿æˆåŠŸåé‡ç½®è®¡æ•°å™¨

## è°ƒè¯•æ—¥å¿—

åº”ç”¨ä¼šè¾“å‡ºè¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ï¼š

```
[HH:mm:ss.SSS] ğŸ”µ [HypeRate] å¼€å§‹è¿æ¥...
[HH:mm:ss.SSS] ğŸ”µ [HypeRate] è®¾å¤‡ ID: abc123
[HH:mm:ss.SSS] âœ… [HypeRate] WebSocket æ¡æ‰‹æˆåŠŸ
[HH:mm:ss.SSS] ğŸ’“ [HypeRate] å‘é€å¿ƒè·³
[HH:mm:ss.SSS] â¤ï¸ [HypeRate] å¿ƒç‡æ›´æ–°: 78 BPM
```

æ—¥å¿—å¯ä»¥é€šè¿‡ Console.app æŸ¥çœ‹æˆ–é‡å®šå‘åˆ°æ–‡ä»¶ï¼š

```bash
./HypeRateOnMac.app/Contents/MacOS/HypeRateOnMac > app.log 2>&1
```

## å¼€å‘è¯´æ˜

### æ„å»ºè¦æ±‚

- macOS 13.0+
- Xcode 14.0+
- Swift 5.0+

### è¿è¡Œé¡¹ç›®

1. å…‹éš†ä»“åº“
2. æ‰“å¼€ `HypeRateOnMac.xcodeproj`
3. åœ¨ Xcode ä¸­é€‰æ‹©ç›®æ ‡è®¾å¤‡
4. ç‚¹å‡» Runï¼ˆâŒ˜Rï¼‰

### ä»£ç å…³é”®ç‚¹

#### HeartRateService

- ç»§æ‰¿ `NSObject` ä»¥å®ç° `URLSessionWebSocketDelegate`
- ä½¿ç”¨ `DispatchSourceTimer` å®ç°å¯é çš„å¿ƒè·³å’Œé‡è¿å®šæ—¶å™¨
- ä½¿ç”¨ `JSONSerialization` ç›´æ¥å¤„ç† JSONï¼Œç§»é™¤äº†æŠ½è±¡çš„ `WebSocketMessage` æ¨¡å‹

#### MenuBarView

- æ ¹æ®è¿æ¥çŠ¶æ€åŠ¨æ€æ˜¾ç¤ºä¸åŒå›¾æ ‡å’Œé¢œè‰²
- ä½¿ç”¨ SwiftUI æ„å»ºï¼Œé€šè¿‡ `NSHostingController` é›†æˆåˆ° AppKit

#### HeartRateViewModel

- ä½¿ç”¨ Combine æ¡†æ¶è¿›è¡Œå“åº”å¼æ•°æ®æµ
- åè°ƒ `HeartRateService` å’Œ `SettingsService`
- æä¾›è¿æ¥ç®¡ç†æ–¹æ³•ï¼ˆconnectã€disconnectã€reconnectï¼‰

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ã€‚

## ç›¸å…³é“¾æ¥

- [HypeRate å®˜ç½‘](https://hyperate.io/)
- [HypeRate WebSocket API æ–‡æ¡£](https://github.com/HypeRate/HypeRate-Websocket-API)
